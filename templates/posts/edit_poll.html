{% extends "pages/layouts/_base.html" %}
{% load static %}

{% block title %}Editar Encuesta - AIT{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<div class="container mt-3">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Inicio</a></li>
            <li class="breadcrumb-item"><a href="{% url 'posts:poll_list' %}">Encuestas</a></li>
            <li class="breadcrumb-item"><a href="{% url 'posts:poll_manager' %}">Gesti贸n</a></li>
            <li class="breadcrumb-item active" aria-current="page">Editar: {{ poll.title }}</li>
        </ol>
    </nav>
</div>

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-4">
                        <i class="fas fa-edit fa-2x me-3" style="color: #184da1;"></i>
                        <h2 class="card-title fw-bold mb-0" style="color: #184da1;">Editar Encuesta</h2>
                    </div>
                    
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <form method="post" enctype="multipart/form-data" id="editPollForm">
                        {% csrf_token %}
                        
                        <!-- Informaci贸n B谩sica -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="title" class="form-label fw-semibold">T铆tulo de la Encuesta *</label>
                                <input type="text" class="form-control" id="title" name="title" value="{{ poll.title }}" maxlength="30" required>
                                <div class="form-text">M谩ximo 30 caracteres</div>
                            </div>
                            <div class="col-md-3">
                                <label for="status" class="form-label fw-semibold">Estado</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="BORRADOR" {% if poll.status == 'BORRADOR' %}selected{% endif %}>Borrador</option>
                                    <option value="ACTIVA" {% if poll.status == 'ACTIVA' %}selected{% endif %}>Activa</option>
                                    <option value="CERRADA" {% if poll.status == 'CERRADA' %}selected{% endif %}>Cerrada</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="image" class="form-label fw-semibold">Imagen</label>
                                <input type="file" class="form-control" id="image" name="image" accept="image/*">
                                {% if poll.image %}
                                    <small class="text-muted d-block mt-1">Actual: {{ poll.image.name|truncatechars:20 }}</small>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="description" class="form-label fw-semibold">Descripci贸n</label>
                            <textarea class="form-control" id="description" name="description" rows="3" placeholder="Describe brevemente el prop贸sito de esta encuesta...">{{ poll.description }}</textarea>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- Secci贸n de Preguntas -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h4 class="fw-bold mb-1" style="color: #184da1;">Preguntas</h4>
                                <small class="text-muted">Edita las preguntas existentes o agrega nuevas</small>
                            </div>
                            <button type="button" class="btn btn-success" onclick="addNewQuestion()">
                                <i class="fas fa-plus me-2"></i>Agregar Pregunta
                            </button>
                        </div>
                        
                        <div id="questionsContainer" class="mb-4">
                            {% for question in poll.preguntas.all %}
                            <div class="card mb-3 question-card" id="existing-question-{{ question.id }}">
                                <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #f8f9fa;">
                                    <h6 class="mb-0 fw-bold" style="color: #184da1;">
                                        <i class="fas fa-question-circle me-2"></i>Pregunta {{ forloop.counter }}
                                    </h6>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeExistingQuestion({{ question.id }})" title="Eliminar pregunta">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <div class="card-body">
                                    <input type="hidden" name="existing_question_id_{{ question.id }}" value="{{ question.id }}">
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Texto de la Pregunta *</label>
                                        <input type="text" class="form-control" name="existing_question_text_{{ question.id }}" value="{{ question.question_text }}" required>
                                    </div>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold">Tipo de Pregunta *</label>
                                            <select class="form-select" name="existing_question_type_{{ question.id }}" onchange="toggleExistingOptions({{ question.id }})" required>
                                                <option value="TEXTO_LIBRE" {% if question.question_type == 'TEXTO_LIBRE' %}selected{% endif %}> Texto Libre</option>
                                                <option value="SELECCION_MULTIPLE" {% if question.question_type == 'SELECCION_MULTIPLE' %}selected{% endif %}> Selecci贸n M煤ltiple</option>
                                                <option value="ESCALA_NUMERICA" {% if question.question_type == 'ESCALA_NUMERICA' %}selected{% endif %}> Escala Num茅rica (1-5)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold">驴Es obligatoria?</label>
                                            <select class="form-select" name="existing_is_obligatory_{{ question.id }}">
                                                <option value="false" {% if not question.is_obligatory %}selected{% endif %}>No</option>
                                                <option value="true" {% if question.is_obligatory %}selected{% endif %}>S铆</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div id="existing-options-container-{{ question.id }}" class="options-container" {% if question.question_type != 'SELECCION_MULTIPLE' %}style="display: none;"{% endif %}>
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label fw-semibold mb-0">Opciones de Respuesta</label>
                                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addExistingOption({{ question.id }})">
                                                <i class="fas fa-plus me-1"></i>Agregar Opci贸n
                                            </button>
                                        </div>
                                        <div id="existing-options-list-{{ question.id }}">
                                            {% for option in question.opciones.all %}
                                            <div class="input-group mb-2">
                                                <span class="input-group-text">Opci贸n {{ forloop.counter }}</span>
                                                <input type="hidden" name="existing_option_id_{{ question.id }}_{{ option.id }}" value="{{ option.id }}">
                                                <input type="text" class="form-control" name="existing_option_text_{{ question.id }}_{{ option.id }}" value="{{ option.options_text }}" required>
                                                <button type="button" class="btn btn-outline-danger" onclick="removeExistingOption(this, {{ question.id }}, {{ option.id }})" title="Eliminar opci贸n">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        <small class="text-muted">Agrega al menos 2 opciones para preguntas de selecci贸n m煤ltiple</small>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a href="{% url 'posts:poll_manager' %}" class="btn btn-outline-secondary me-md-2">
                                <i class="fas fa-arrow-left me-2"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Guardar Cambios
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let newQuestionCount = 0;

function addNewQuestion() {
    newQuestionCount++;
    const container = document.getElementById('questionsContainer');
    
    const questionDiv = document.createElement('div');
    questionDiv.className = 'card mb-3 question-card';
    questionDiv.id = `new-question-${newQuestionCount}`;
    
    questionDiv.innerHTML = `
        <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #e8f5e8;">
            <h6 class="mb-0 fw-bold" style="color: #27ae60;">
                <i class="fas fa-plus-circle me-2"></i>Nueva Pregunta
            </h6>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeNewQuestion(${newQuestionCount})" title="Eliminar pregunta">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label fw-semibold">Texto de la Pregunta *</label>
                <input type="text" class="form-control" name="new_question_text_${newQuestionCount}" placeholder="Escribe tu pregunta aqu铆..." required>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Tipo de Pregunta *</label>
                    <select class="form-select" name="new_question_type_${newQuestionCount}" onchange="toggleNewOptions(${newQuestionCount})" required>
                        <option value="">Seleccionar tipo</option>
                        <option value="TEXTO_LIBRE"> Texto Libre</option>
                        <option value="SELECCION_MULTIPLE"> Selecci贸n M煤ltiple</option>
                        <option value="ESCALA_NUMERICA"> Escala Num茅rica (1-5)</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-semibold">驴Es obligatoria?</label>
                    <select class="form-select" name="new_is_obligatory_${newQuestionCount}">
                        <option value="false">No</option>
                        <option value="true">S铆</option>
                    </select>
                </div>
            </div>
            
            <div id="new-options-container-${newQuestionCount}" class="options-container" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label fw-semibold mb-0">Opciones de Respuesta</label>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addNewOption(${newQuestionCount})">
                        <i class="fas fa-plus me-1"></i>Agregar Opci贸n
                    </button>
                </div>
                <div id="new-options-list-${newQuestionCount}">
                    <!-- Opciones se agregar谩n aqu铆 -->
                </div>
                <small class="text-muted">Agrega al menos 2 opciones para preguntas de selecci贸n m煤ltiple</small>
            </div>
        </div>
    `;
    
    container.appendChild(questionDiv);
}

function removeNewQuestion(questionId) {
    if (confirm('驴Est谩s seguro de que quieres eliminar esta pregunta?')) {
        document.getElementById(`new-question-${questionId}`).remove();
    }
}

function removeExistingQuestion(questionId) {
    if (confirm('驴Est谩s seguro de que quieres eliminar esta pregunta? Esta acci贸n no se puede deshacer.')) {
        const questionDiv = document.getElementById(`existing-question-${questionId}`);
        questionDiv.style.display = 'none';
        // Agregar campo oculto para marcar como eliminada
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = `delete_question_${questionId}`;
        hiddenInput.value = 'true';
        questionDiv.appendChild(hiddenInput);
    }
}

function toggleExistingOptions(questionId) {
    const select = document.querySelector(`select[name="existing_question_type_${questionId}"]`);
    const optionsContainer = document.getElementById(`existing-options-container-${questionId}`);
    
    if (select.value === 'SELECCION_MULTIPLE') {
        optionsContainer.style.display = 'block';
    } else {
        optionsContainer.style.display = 'none';
    }
}

function toggleNewOptions(questionId) {
    const select = document.querySelector(`select[name="new_question_type_${questionId}"]`);
    const optionsContainer = document.getElementById(`new-options-container-${questionId}`);
    const optionsList = document.getElementById(`new-options-list-${questionId}`);
    
    if (select.value === 'SELECCION_MULTIPLE') {
        optionsContainer.style.display = 'block';
        optionsList.innerHTML = '';
        addNewOption(questionId);
        addNewOption(questionId);
    } else {
        optionsContainer.style.display = 'none';
        optionsList.innerHTML = '';
    }
}

function addExistingOption(questionId) {
    const optionsList = document.getElementById(`existing-options-list-${questionId}`);
    const optionCount = optionsList.children.length + 1;
    
    const optionDiv = document.createElement('div');
    optionDiv.className = 'input-group mb-2';
    optionDiv.innerHTML = `
        <span class="input-group-text">Opci贸n ${optionCount}</span>
        <input type="text" class="form-control" name="new_existing_option_${questionId}_${Date.now()}" placeholder="Texto de la opci贸n" required>
        <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()" title="Eliminar opci贸n">
            <i class="fas fa-trash"></i>
        </button>
    `;
    
    optionsList.appendChild(optionDiv);
}

function addNewOption(questionId) {
    const optionsList = document.getElementById(`new-options-list-${questionId}`);
    const optionCount = optionsList.children.length + 1;
    
    const optionDiv = document.createElement('div');
    optionDiv.className = 'input-group mb-2';
    optionDiv.innerHTML = `
        <span class="input-group-text">Opci贸n ${optionCount}</span>
        <input type="text" class="form-control" name="new_option_${questionId}_${optionCount}" placeholder="Texto de la opci贸n" required>
        <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()" title="Eliminar opci贸n">
            <i class="fas fa-trash"></i>
        </button>
    `;
    
    optionsList.appendChild(optionDiv);
}

function removeExistingOption(button, questionId, optionId) {
    if (confirm('驴Eliminar esta opci贸n?')) {
        const optionDiv = button.parentElement;
        optionDiv.style.display = 'none';
        // Marcar para eliminaci贸n
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = `delete_option_${questionId}_${optionId}`;
        hiddenInput.value = 'true';
        optionDiv.appendChild(hiddenInput);
    }
}
</script>

<style>
.question-card {
    transition: all 0.3s ease;
}

.question-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
}

.options-container {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.input-group .form-control:focus {
    border-color: #184da1;
    box-shadow: 0 0 0 0.2rem rgba(24, 77, 161, 0.25);
}

.btn-outline-primary:hover {
    background-color: #184da1;
    border-color: #184da1;
}

.form-select:focus {
    border-color: #184da1;
    box-shadow: 0 0 0 0.2rem rgba(24, 77, 161, 0.25);
}
</style>
{% endblock %}