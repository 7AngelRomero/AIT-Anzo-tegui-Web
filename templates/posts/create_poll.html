{% extends "pages/layouts/_base.html" %}
{% load static %}

{% block title %}Crear Encuesta - AIT{% endblock %}

{% block content %}
<!-- Breadcrumb -->
<div class="container mt-3">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}">Inicio</a></li>
            <li class="breadcrumb-item"><a href="{% url 'posts:poll_list' %}">Encuestas</a></li>
            <li class="breadcrumb-item"><a href="{% url 'posts:poll_manager' %}">Gesti칩n</a></li>
            <li class="breadcrumb-item active" aria-current="page">Crear Encuesta</li>
        </ol>
    </nav>
</div>

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center mb-4">
                        <i class="fas fa-poll fa-2x me-3" style="color: #184da1;"></i>
                        <h2 class="card-title fw-bold mb-0" style="color: #184da1;">Crear Nueva Encuesta</h2>
                    </div>
                    
                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                    
                    <form method="post" enctype="multipart/form-data" id="pollForm" novalidate>
                        {% csrf_token %}
                        
                        <!-- Informaci칩n B치sica -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="title" class="form-label fw-semibold">T칤tulo de la Encuesta *</label>
                                <input type="text" class="form-control" id="title" name="title" maxlength="30" required>
                                <div class="form-text">M치ximo 30 caracteres</div>
                            </div>
                            <div class="col-md-3">
                                <label for="status" class="form-label fw-semibold">Estado</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="BORRADOR" selected>Borrador</option>
                                    <option value="ACTIVA">Activa</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="image" class="form-label fw-semibold">Imagen</label>
                                <input type="file" class="form-control" id="image" name="image" accept="image/*">
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label for="description" class="form-label fw-semibold">Descripci칩n</label>
                            <textarea class="form-control" id="description" name="description" rows="3" placeholder="Describe brevemente el prop칩sito de esta encuesta..."></textarea>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- Secci칩n de Preguntas -->
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h4 class="fw-bold mb-1" style="color: #184da1;">Preguntas</h4>
                                <small class="text-muted">Agrega al menos una pregunta para tu encuesta</small>
                            </div>
                            <button type="button" class="btn btn-success" onclick="addQuestion()">
                                <i class="fas fa-plus me-2"></i>Agregar Pregunta
                            </button>
                        </div>
                        
                        <div id="questionsContainer" class="mb-4">
                            <!-- Las preguntas se agregar치n din치micamente -->
                        </div>
                        
                        <div class="alert alert-info d-none" id="noQuestionsAlert">
                            <i class="fas fa-info-circle me-2"></i>
                            Debes agregar al menos una pregunta antes de crear la encuesta.
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a href="{% url 'posts:poll_manager' %}" class="btn btn-outline-secondary me-md-2">
                                <i class="fas fa-arrow-left me-2"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary" id="submitBtn">
                                <i class="fas fa-save me-2"></i>Crear Encuesta
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let questionCount = 0;

function addQuestion() {
    questionCount++;
    const container = document.getElementById('questionsContainer');
    
    const questionDiv = document.createElement('div');
    questionDiv.className = 'card mb-3 question-card';
    questionDiv.id = `question-${questionCount}`;
    
    questionDiv.innerHTML = `
        <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #f8f9fa;">
            <h6 class="mb-0 fw-bold" style="color: #184da1;">
                <i class="fas fa-question-circle me-2"></i>Pregunta ${questionCount}
            </h6>
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeQuestion(${questionCount})" title="Eliminar pregunta">
                <i class="fas fa-trash"></i>
            </button>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label fw-semibold">Texto de la Pregunta *</label>
                <input type="text" class="form-control" name="question_text_${questionCount}" placeholder="Escribe tu pregunta aqu칤..." required>
            </div>
            
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label fw-semibold">Tipo de Pregunta *</label>
                    <select class="form-select" name="question_type_${questionCount}" onchange="toggleOptions(${questionCount})" required>
                        <option value="">Seleccionar tipo</option>
                        <option value="TEXTO_LIBRE">游닇 Texto Libre</option>
                        <option value="SELECCION_MULTIPLE">游댖 Selecci칩n M칰ltiple</option>
                        <option value="ESCALA_NUMERICA">游늵 Escala Num칠rica (1-5)</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label fw-semibold">쮼s obligatoria?</label>
                    <select class="form-select" name="is_obligatory_${questionCount}">
                        <option value="false">No</option>
                        <option value="true">S칤</option>
                    </select>
                </div>
            </div>
            
            <div id="options-container-${questionCount}" class="options-container" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label fw-semibold mb-0">Opciones de Respuesta</label>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="addOption(${questionCount})">
                        <i class="fas fa-plus me-1"></i>Agregar Opci칩n
                    </button>
                </div>
                <div id="options-list-${questionCount}">
                    <!-- Opciones se agregar치n aqu칤 -->
                </div>
                <small class="text-muted">Agrega al menos 2 opciones para preguntas de selecci칩n m칰ltiple</small>
            </div>
        </div>
    `;
    
    container.appendChild(questionDiv);
    updateQuestionNumbers();
    updateNoQuestionsAlert();
}

function removeQuestion(questionId) {
    if (confirm('쮼st치s seguro de que quieres eliminar esta pregunta?')) {
        const questionDiv = document.getElementById(`question-${questionId}`);
        questionDiv.remove();
        updateQuestionNumbers();
        updateNoQuestionsAlert();
    }
}

function updateQuestionNumbers() {
    const questions = document.querySelectorAll('.question-card');
    questions.forEach((question, index) => {
        const header = question.querySelector('.card-header h6');
        header.innerHTML = `<i class="fas fa-question-circle me-2"></i>Pregunta ${index + 1}`;
    });
}

function updateNoQuestionsAlert() {
    const container = document.getElementById('questionsContainer');
    const alert = document.getElementById('noQuestionsAlert');
    const submitBtn = document.getElementById('submitBtn');
    
    if (container.children.length === 0) {
        alert.classList.remove('d-none');
        submitBtn.disabled = true;
    } else {
        alert.classList.add('d-none');
        submitBtn.disabled = false;
    }
}

function toggleOptions(questionId) {
    const select = document.querySelector(`select[name="question_type_${questionId}"]`);
    const optionsContainer = document.getElementById(`options-container-${questionId}`);
    const optionsList = document.getElementById(`options-list-${questionId}`);
    
    if (select.value === 'SELECCION_MULTIPLE') {
        optionsContainer.style.display = 'block';
        // Limpiar opciones existentes
        optionsList.innerHTML = '';
        // Agregar 2 opciones por defecto
        addOption(questionId);
        addOption(questionId);
    } else {
        optionsContainer.style.display = 'none';
        optionsList.innerHTML = '';
    }
}

function addOption(questionId) {
    const optionsList = document.getElementById(`options-list-${questionId}`);
    const optionCount = optionsList.children.length + 1;
    
    const optionDiv = document.createElement('div');
    optionDiv.className = 'input-group mb-2';
    optionDiv.innerHTML = `
        <span class="input-group-text">Opci칩n ${optionCount}</span>
        <input type="text" class="form-control" name="option_${questionId}_${optionCount}" placeholder="Texto de la opci칩n" required>
        <button type="button" class="btn btn-outline-danger" onclick="removeOption(this)" title="Eliminar opci칩n">
            <i class="fas fa-trash"></i>
        </button>
    `;
    
    optionsList.appendChild(optionDiv);
}

function removeOption(button) {
    const optionDiv = button.parentElement;
    const optionsList = optionDiv.parentElement;
    optionDiv.remove();
    
    // Renumerar opciones
    const options = optionsList.querySelectorAll('.input-group');
    options.forEach((option, index) => {
        const span = option.querySelector('.input-group-text');
        span.textContent = `Opci칩n ${index + 1}`;
    });
}

// Validaci칩n del formulario
document.getElementById('pollForm').addEventListener('submit', function(e) {
    const questions = document.querySelectorAll('.question-card');
    
    if (questions.length === 0) {
        e.preventDefault();
        alert('Debes agregar al menos una pregunta.');
        return;
    }
    
    // Validar que las preguntas de selecci칩n m칰ltiple tengan al menos 2 opciones
    let valid = true;
    questions.forEach(question => {
        const questionId = question.id.split('-')[1];
        const typeSelect = question.querySelector(`select[name="question_type_${questionId}"]`);
        
        if (typeSelect.value === 'SELECCION_MULTIPLE') {
            const options = question.querySelectorAll(`input[name^="option_${questionId}_"]`);
            const filledOptions = Array.from(options).filter(opt => opt.value.trim() !== '');
            
            if (filledOptions.length < 2) {
                valid = false;
                alert(`La pregunta ${question.querySelector('h6').textContent} debe tener al menos 2 opciones.`);
            }
        }
    });
    
    if (!valid) {
        e.preventDefault();
    }
});

// Agregar primera pregunta por defecto
addQuestion();
</script>

<style>
.question-card {
    transition: all 0.3s ease;
}

.question-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
}

.options-container {
    background-color: #f8f9fa;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.input-group .form-control:focus {
    border-color: #184da1;
    box-shadow: 0 0 0 0.2rem rgba(24, 77, 161, 0.25);
}

.btn-outline-primary:hover {
    background-color: #184da1;
    border-color: #184da1;
}

.form-select:focus {
    border-color: #184da1;
    box-shadow: 0 0 0 0.2rem rgba(24, 77, 161, 0.25);
}
</style>
{% endblock %}